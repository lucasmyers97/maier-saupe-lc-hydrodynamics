\documentclass[reqno]{article}
\usepackage{../format-doc}

\newcommand{\fb}{f_\text{bulk}}
\newcommand{\fe}{f_\text{elastic}}
\newcommand{\fs}{f_\text{surf}}
\newcommand{\tr}{\text{tr}}

\begin{document}
\title{Including boundary free energy}
\author{Lucas Myers}
\maketitle

\section{Effect of surface free energy}

Recently we have been observing that a low-twist-constant configuration in a cylindrical domain with strong homeotropic anchoring on the boundaries tends to exhibit a director structure which rotates out of the plane on the cylinder ends.
This happens in an oscillatory fashion, and also increases the uniaxial scalar order parameter to be close to the physical limit of the $Q$-tensor.
Hence, we are seeking to prevent this behavior in order to try to reproduce the chiral twist configuration.
This is done by imposing a weak planar surface anchoring term on the cylinder ends.

In the paper by Fournier and Galatola they introduce two terms which they take to be minimal in imperically representing good planar anchoring behavior.
The first term (weakly) imposes that $Q$ must coincide with its projection on the substrate.
The second term (wealy) imposes that the scalar order parameter on the surface is equal to some specified equilibrium value $S_0$.
To this end, they define:
\begin{equation}
    \tilde{Q}
    =
    Q
    - \frac13 S_0 I
\end{equation}
The projection is given by:
\begin{equation} \label{eq:Q-projection}
    \tilde{Q}^\perp
    =
    P \tilde{Q} P
\end{equation}
with $P = I - \boldsymbol{\nu} \otimes \boldsymbol{\nu}$ and $\boldsymbol{\nu}$ a unit vector normal to the surface.
The term that shows up in the surface free energy density is:
\begin{equation}
    W_1 \left(\tilde{Q}_{ij} - \tilde{Q}^\perp_{ij} \right)\left(\tilde{Q}_{ij} - \tilde{Q}^\perp_{ij} \right)
\end{equation}

To better understand this term, we expand eq. \eqref{eq:Q-projection} in terms of $Q$:
\begin{equation}
\begin{split}
    P \left( Q - \frac13 S_0 I \right) P
    &=
    P Q P - \frac13 S_0 P^2 \\
    &= P Q P - \frac13 S_0 P
\end{split}
\end{equation}
Then the difference with the projection onto the substrate:
\begin{equation}
\begin{split}
    \tilde{Q} - \tilde{Q}^\perp
    &=
    Q - \frac13 S_0 I
    - PQP + \frac13 S_0 P \\
    &= Q - PQP - \frac13 S_0 \left( \boldsymbol{\nu} \otimes \boldsymbol{\nu} \right)
\end{split}
\end{equation}
Supposing $\boldsymbol{\nu}$ coincides with $\hat{\mathbf{z}}$ the effect of $PQP$ is just to eliminate the third row and column of $Q$.
This quantity (squared) is then minimized when the third row and column of $Q$ are zero except for the $(3, 3)$ entry which contains $\frac13 S_0$.
This is true for uniaxial nematics for which $\mathbf{n}$ is in the $x$-$y$ plane and have scalar order parameter $S_0$. 

The second term reads:
\begin{equation}
    W_2 \left(\tilde{Q}_{ij} \tilde{Q}_{ij} - S_0^2 \right)^2
\end{equation}
In terms of $Q$ one of the factors reads:
\begin{equation}
\begin{split}
    \left(Q_{ij} + \frac13 S_0 \delta_{ij}\right)\left(Q_{ij} + \frac13 S_0 \delta_{ij}\right)
    - S_0^2
    &=
    Q_{ij} Q_{ij} + \frac13 S_0^2 - S_0^2 \\
    &=
    Q_{ij} Q_{ij} - \tfrac23 S_0^2
\end{split}
\end{equation}
In general, in a bases in which $Q$ is diagonalied, it reads:
\begin{equation}
    Q
    =
    \begin{bmatrix}
    \frac23 S &0 &0 \\
    0 &\left(P - \frac13 S\right) &0 \\
    0 &0 &-\left(P + \frac13 S\right)
    \end{bmatrix}
\end{equation}
With this general form we get:
\begin{equation}
    Q_{ij} Q_{ij}
    =
    \frac23 S^2 + 2 P^2 
\end{equation}
For a uniaxial system, the surface potential is minimized for $S = S_0$.
It appears that these two conditions impose that $\mathbf{\hat{n}}$ lies in the plane orthogonal to $\boldsymbol{\hat{\nu}}$ and also that the scalar order parameter does not deviate too much from $S_0$.

\section{Including surface free energy in equation of motion}

The total free energy, including the surface term, reads:
\begin{equation}
    F
    =
    \int_\Omega \left[ 
        \fb
        + \fe
    \right]
    dV
    +
    \int_{\partial \Omega}
    \fs \,
    dS
\end{equation}
\href{https://www.wikiwand.com/en/Functional_derivative#Functional_differential}{By definition} we have:
\begin{equation} \label{eq:free-energy-differential}
\begin{split}
    \delta F[Q, \delta Q]
    &=
    \left. \frac{d}{d \tau} F[Q + \tau \delta Q] \right|_{\tau = 0} \\
    &=
    \int_\Omega \left[
        \frac{\partial \fb}{\partial Q_{ij}} \delta Q_{ij}
        + \frac{\partial \fe}{\partial Q_{ij}} \delta Q_{ij}
        + \frac{\partial \fe}{\partial \left(\partial_k Q_{ij}\right)} \partial_k \delta Q_{ij}
    \right] dV
    +
    \int_{\partial \Omega} \frac{\partial \fs}{\partial Q_{ij}} \delta Q_{ij} dS \\
    &=
    \int_\Omega \left[
        \frac{\partial \fb}{\partial Q_{ij}}
        + \frac{\partial \fe}{\partial Q_{ij}}
        - \partial_k \frac{\partial \fe}{\partial \left(\partial_k Q_{ij}\right)}
    \right] \delta Q_{ij} \, dV
    +
    \int_{\partial \Omega} \left[
        \frac{\partial \fs}{\partial Q_{ij}} 
        + \frac{\partial \fe}{\partial \left(\partial_k Q_{ij}\right)} \nu_k
    \right] \delta Q_{ij} \, dS
\end{split}
\end{equation}
We have previously calculated each of these terms explicitly, save the derivative of the surface free energy.
We do this now:
\begin{equation}
\begin{split}
    \frac{\partial \fs}{\partial Q_{ij}}
    &=
    \begin{multlined}[t]
        W_1
        \frac{\partial}{\partial Q_{ij}}
        \left[ Q_{kl} - P_{km} Q_{mn} P_{nl} - \frac13 S_0 \nu_k \nu_l\right] 
        \left[ Q_{kl} - P_{k\alpha} Q_{\alpha \beta} P_{\beta l} - \frac13 S_0 \nu_k \nu_l\right] \\
        + 
        W_2 
        \frac{\partial}{\partial Q_{ij}}
        \left[ Q_{kl} Q_{kl} - \frac23 S_0^2 \right]^2
    \end{multlined} \\
    &=
    \begin{multlined}[t]
        2 W_1 \left[ \delta_{ik} \delta_{jl} - P_{km} \delta_{im} \delta_{jn} P_{nl} \right]
        \left[ Q_{kl} - P_{k\alpha} Q_{\alpha \beta} P_{\beta l} - \frac13 S_0 \nu_k \nu_l\right] \\
        + 
        2 W_2 \left[ Q_{kl} Q_{kl} - \frac23 S_0^2 \right] 2 \delta_{ik} \delta_{jl} Q_{kl}
    \end{multlined} \\
    &=
    \begin{multlined}[t]
        2 W_1 \left(
        \left[ Q_{ij} - P_{i\alpha} Q_{\alpha \beta} P_{\beta j} - \frac13 S_0 \nu_i \nu_j\right]
        - P_{ik} \left[ Q_{kl} - P_{k\alpha} Q_{\alpha \beta} P_{\beta l} - \frac13 S_0 \nu_k \nu_l\right] P_{lj}
        \right) \\
        + 
        4 W_2 \left[ Q_{kl} Q_{kl} - \frac23 S_0^2 \right] Q_{ij}
    \end{multlined} \\
    &=
    2 W_1 \left[ Q - PQP - \frac13 S_0 \left( \boldsymbol\nu \otimes \boldsymbol\nu \right) \right]
    + 4 W_2 \left[ Q : Q - \frac23 S_0^2 \right] Q
\end{split}
\end{equation}
where we have used the fact that $PP = P$ and that:
\begin{equation}
\begin{split}
    P \left( \boldsymbol{\nu} \otimes \boldsymbol{\nu} \right) P
    &= 
    \left(I - \boldsymbol{\nu} \otimes \boldsymbol{\nu}\right)
    \left( \boldsymbol{\nu} \otimes \boldsymbol{\nu} \right)
    \left(I - \boldsymbol{\nu} \otimes \boldsymbol{\nu}\right) \\
    &=
    \boldsymbol{\nu} \otimes \boldsymbol{\nu}
    - \boldsymbol{\nu} \otimes \boldsymbol{\nu}
    - \boldsymbol{\nu} \otimes \boldsymbol{\nu}
    + \boldsymbol{\nu} \otimes \boldsymbol{\nu} \\
    &=
    0
\end{split}
\end{equation}
One problem remains, which is that the $W_1$ term is not necessarily traceless.
To accommodate this formally, one introduces a Lagrange multiplier term of the form $\lambda Q_{ii}$ to the free energy.
The result takes the form of just subtracting off $I$ scaled by a third of the trace, which we calculate below:
\begin{equation}
\begin{split}
    \tr \left(Q - PQP - \frac13 S_0 \left(\boldsymbol\nu \otimes \boldsymbol\nu\right) \right)
    &=
    \tr(Q) - \tr (PQ) - \frac13 S_0 \\
    &=
    \tr(Q) - \tr(Q) + \tr\left(\left(\boldsymbol\nu \otimes \boldsymbol\nu\right) Q \right) - \frac13 S_0 \\
    &=
    \delta_{ij} \nu_i \nu_k Q_{kj} - \frac13 S_0 \\
    &= \boldsymbol\nu^T Q \boldsymbol\nu - \frac13 S_0
\end{split}
\end{equation}
where we have used $PP = P$, and several properties of the trace.
Plugging back in yields:
\begin{equation}
    \frac{\partial \fs}{\partial Q}
    =
    2 W_1 \left[ 
        Q - PQP - \frac13 S_0 \left( \boldsymbol\nu \otimes \boldsymbol\nu \right)
        - \frac13 \left(\boldsymbol\nu^T Q \boldsymbol\nu - \frac13 S_0\right) I
    \right]
    + 4 W_2 \left[ Q : Q - \frac23 S_0^2 \right] Q
\end{equation}
for which the trace is zero.

Now, at each instant $Q$ must be evolving in such a way that decreases $F$. 
If we take $-\partial Q / \partial t$ to be terms in brackets in eq. \eqref{eq:free-energy-differential} in the bulk and on the surface respectively then $\delta F / \delta t \leq 0$ at all times.
So then we end up with two coupled equations:
\begin{align}
    \frac{\partial Q}{\partial t}
    &=
    -\frac{\partial \fb}{\partial Q}
    - \frac{\partial \fe}{\partial Q}
    + \nabla \cdot \frac{\partial \fe}{\partial \left(\nabla Q\right)} &&\text{(bulk)} \\
    \frac{\partial Q}{\partial t}
    &=
    -\frac{\partial \fs}{\partial Q}
    - \boldsymbol\nu \cdot \frac{\partial \fe}{\partial \left(\nabla Q\right)} &&\text{(surface)} \\
\end{align}
To simplify notation, take $T^Q = -\partial (\fb + \fe) / \partial Q$ and $T^{\nabla Q} = \partial \fe / \partial (\nabla Q)$.
Also take $T^s = -\partial \fs / \partial Q$.
Then these read:
\begin{align}
    \frac{\partial Q}{\partial t} \label{eq:Q-bulk-evolution}
    &=
    T^Q
    + \nabla \cdot T^{\nabla Q} \\
    \frac{\partial Q}{\partial t} \label{eq:Q-surf-evolution}
    &=
    T^s
    - \boldsymbol\nu \cdot T^{\nabla Q}
\end{align}

\section{Discretizing in time}

Define $T(Q, \nabla Q)$ to be the righthand side of eq. \eqref{eq:Q-bulk-evolution} or \eqref{eq:Q-surf-evolution} depending on context.
Then a semi-implicit time-discretization scheme looks like:
\begin{equation}
    \frac{Q - Q_0}{\delta t} 
    =
    \theta \, T(Q_0, \nabla Q_0)
    + (1 - \theta) \, T(Q, \nabla Q)
\end{equation}
where $\delta t$ is the discrete time-step and $\theta$ is a parameter controlling how implicit vs. explicit the method is.
For $\theta = 1$ it is explicit, $\theta = 0$ it is implicit, and $\theta = 1/2$ it is a Crank-Nicolson scheme.
Since this is a nonlinear equation, we write a residual whose zeros we seek:
\begin{equation}
    R(Q, \nabla Q)
    =
    Q - Q_0
    - \delta t \left[
        \theta \, T(Q_0, \nabla Q_0)
        + (1 - \theta) \, T(Q, \nabla Q)
    \right]
\end{equation}
To use a Newton-Rhapson method, we must take the Gateaux derivative of $R$:
\begin{equation}
    dR(Q, \nabla Q) \, \delta Q
    =
    \frac{d}{d \tau}
    \left[
        R(Q + \tau \delta Q, \nabla Q + \tau \nabla \delta Q)
    \right]_{\tau = 0}
\end{equation}
Then, the Newton-Rhapson method reads:
\begin{equation} \label{eq:newton-rhapson}
    dR \, \delta Q 
    = -\alpha R
\end{equation}
where $\alpha \leq 0$ is some stabilization constant, and this is a linear equation in $\delta Q$.
Now, such an equation will apply separately to the surface and the bulk.
To accommodate the surface terms with the finite element method, we write out eq. \eqref{eq:newton-rhapson} explicitly for the surface terms:
\begin{equation} \label{eq:surface-weak-form}
\begin{split}
&\begin{multlined}[t]
    \delta Q - \delta t \left(1 - \theta\right) \left[ dT^s \delta Q - \boldsymbol\nu \cdot \left( dT^{\nabla Q} \delta Q \right) \right]
    = \\
    - \alpha \left(
        Q - Q_0 - \delta t \left[
            \theta \left( T_0^s - \boldsymbol\nu \cdot T_0^{\nabla Q} \right)
            + \left(1 - \theta\right) \left( T^s - \boldsymbol\nu \cdot T^{\nabla Q} \right)
        \right]
    \right) 
\end{multlined} \\
\implies
&\begin{multlined}[t]
    \delta t \left(1 - \theta\right) \boldsymbol\nu \cdot \left( dT^{\nabla Q} \delta Q \right)
    + \biggl[ \delta Q - \delta t \left(1 - \theta \right) dT^s \delta Q \biggr]
    = \\
    -\alpha \, \delta t \, \left[ 
        \theta \boldsymbol\nu \cdot T_0^{\nabla Q} + \left(1 - \theta\right) \boldsymbol\nu \cdot T^{\nabla Q} 
    \right]
    -
    \alpha \left(Q - Q_0 - \delta t \left[ \theta T_0^s + \left(1 - \theta\right) T^s \right] \right)
\end{multlined} \\
\implies
&\begin{multlined}[t]
    \delta t \left(1 - \theta\right) \left< \Phi, \boldsymbol\nu \cdot \left( dT^{\nabla Q} \delta Q \right) \right>_{\partial \Omega}
    + \biggl[ \left< \Phi, \delta Q \right>_{\partial \Omega} - \delta t \left(1 - \theta \right) \left< \Phi, dT^s \delta Q \right>_{\partial \Omega} \biggr]
    = \\
    -\alpha \, \delta t \, \left[ 
        \theta \left<\Phi, \boldsymbol\nu \cdot T_0^{\nabla Q}\right>_{\partial \Omega} + \left(1 - \theta\right) \left<\Phi, \boldsymbol\nu \cdot T^{\nabla Q} \right>_{\partial \Omega}
    \right] \\
    -
    \alpha \left(
        \left<\Phi, Q\right>_{\partial \Omega} 
            - \left< \Phi, Q_0 \right>_{\partial \Omega} 
            - \delta t \left[ 
                \theta \left<\Phi, T_0^s\right>_{\partial \Omega} 
                + \left(1 - \theta\right) \left< \Phi, T^s \right>_{\partial \Omega} 
            \right] 
    \right)
\end{multlined}
\end{split}
\end{equation}
where, in the last line, we have taken the inner product with an arbitrary test function $\Phi$ to get the weak form of the equation.
We have also very deliberately separated out the terms corresponding to the elastic energy, as those will appear in the corresponding bulk equation as follows:
\begin{equation} \label{eq:bulk-weak-form}
\begin{split}
&\begin{multlined}[t]
    \delta Q - \delta t \left(1 - \theta \right) \left[dT^Q \delta Q + \nabla \cdot \left( dT^{\nabla Q} \delta Q \right)\right] 
    = \\
    - \alpha \left( 
        Q - Q_0 - \delta t \left[ 
            \theta \left(T_0^Q + \nabla \cdot T_0^{\nabla Q} \right)
            + \left(1 - \theta \right) \left( T^Q + \nabla \cdot T^{\nabla Q} \right)
        \right]
    \right)
\end{multlined} \\
\implies
&\begin{multlined}[t]
    \left<\Phi, \delta Q\right> 
    - \delta t \left(1 - \theta \right) \left[
        \left<\Phi, dT^Q \delta Q\right> 
        - \left<\nabla \Phi, dT^{\nabla Q} \delta Q \right>
    \right] 
    - \delta t \left(1 - \theta \right) \left< \Phi, \boldsymbol\nu \cdot dT^{\nabla Q} \delta Q\right>_{\partial \Omega}
    = \\
    - \alpha \left( 
        \left<\Phi, Q\right> - \left<\Phi, Q_0\right> - \delta t \left[ 
            \theta \left(\left<\Phi, T_0^Q\right> - \left<\nabla \Phi, T_0^{\nabla Q} \right> \right)
            + \left(1 - \theta \right) \left( \left<\Phi, T^Q\right> - \left<\nabla, T^{\nabla Q} \right> \right)
        \right]
    \right) \\
    + \alpha \, \delta t \left(
        \theta \left<\Phi, \boldsymbol\nu \cdot T_0^{\nabla Q}\right>_{\partial \Omega}
        + \left(1 - \theta\right) \left<\Phi, \boldsymbol\nu \cdot T^{\nabla Q} \right>_{\partial \Omega}
    \right)
\end{multlined}
\end{split}
\end{equation}
Now, we may replace the surface integrals with other surface integrals by using eq. \eqref{eq:surface-weak-form}.
Essentially we take eq. \eqref{eq:surface-weak-form} to be a statement of Robin boundary conditions with the surface terms showing up in eq. \eqref{eq:bulk-weak-form} being the normal derivative terms.
Making this substitution yields:
\begin{equation} \label{eq:weak-form-bulk-with-surface-integrals}
\begin{multlined}[t]
    \left<\Phi, \delta Q\right> 
    - \delta t \left(1 - \theta \right) \left[
        \left<\Phi, dT^Q \delta Q\right> 
        - \left<\nabla \Phi, dT^{\nabla Q} \delta Q \right>
    \right] 
    + \left<\Phi, \delta Q\right>_{\partial \Omega}
    - \delta t \left(1 - \theta \right) \left< \Phi, dT^s \delta Q \right>_{\partial \Omega}
    = \\
    - \alpha \left( 
        \left<\Phi, Q\right> - \left<\Phi, Q_0\right> - \delta t \left[ 
            \theta \left(\left<\Phi, T_0^Q\right> - \left<\nabla \Phi, T_0^{\nabla Q} \right> \right)
            + \left(1 - \theta \right) \left( \left<\Phi, T^Q\right> - \left<\nabla, T^{\nabla Q} \right> \right)
        \right]
    \right) \\
    -
    \alpha \left(
        \left<\Phi, Q\right>_{\partial \Omega} 
            - \left< \Phi, Q_0 \right>_{\partial \Omega} 
            - \delta t \left[ 
                \theta \left<\Phi, T_0^s\right>_{\partial \Omega} 
                + \left(1 - \theta\right) \left< \Phi, T^s \right>_{\partial \Omega} 
            \right] 
    \right)
\end{multlined}
\end{equation}
We have already worked out the bulk terms of eq. \eqref{eq:weak-form-bulk-with-surface-integrals} in detail, so now we focus on the surface terms:
\begin{equation}
    T^s_{ij}(Q, \nabla Q)
    =
    \begin{multlined}[t]
        -2 W_1 \left[
            Q_{ij} 
            - P_{ik} Q_{kl} P_{lj} 
            - \frac13 S_0 \nu_i \nu_j 
            - \frac13 \left( \nu_k \nu_l Q_{kl} - \frac13 S_0 \right) \delta_{ij}
        \right] 
        - 4 W_2 \left[ 
            Q_{kl} Q_{kl}
            - \frac23 S_0^2
        \right] Q_{ij}
    \end{multlined}
\end{equation}
The derivative of this expression is:
\begin{equation}
    dT^s(Q, \nabla Q) \, \delta Q_{ij}
    =
    \begin{multlined}[t]
        -2 W_1 \left[
            \delta Q_{ij} 
            - P_{ik} \delta Q_{kl} P_{lj} 
            - \frac13 \nu_k \nu_l \delta Q_{kl} \delta_{ij}
        \right] \\
        - 4 W_2 \left[ 
            2 \delta Q_{kl} Q_{kl} Q_{ij}
            + Q_{kl} Q_{kl} \delta Q_{ij}
            - \frac23 S_0^2 \delta Q_{ij}
        \right] 
    \end{multlined}
\end{equation}
We must also look at the weak forms. 
The weak forms of $Q$, $Q_0$, and $\delta Q$ are all obvious so we instead focus on the $T^s$ boundary terms:
\begin{equation}
    \left<\Phi, T^s \right>_{\partial \Omega}
    =
    \begin{multlined}[t]
        -2 W_1 \left[
            \left<\Phi, Q\right>_{\partial \Omega}
            - \left<\Phi, PQP \right>_{\partial \Omega}
            - \tfrac13 S_0 \left<\Phi, \boldsymbol\nu \otimes \boldsymbol\nu\right>_{\partial \Omega}
        \right] \\
        - 4 W_2 \left[ 
            \left< \Phi, \left(Q : Q\right) Q \right>_{\partial \Omega}
            - \tfrac23 S_0^2 \left< \Phi, Q \right>_{\partial \Omega}
        \right]
    \end{multlined}
\end{equation}
Here we have gotten rid of the term which is a multiple of $\delta_{ij}$ because $\Phi$ is traceless, and so the inner product is zero.
Additionally:
\begin{equation}
    \left<\Phi, dT^s \, \delta Q\right>_{\partial \Omega}
    =
    \begin{multlined}[t]
        -2 W_1 \left[
            \left< \Phi, \delta Q \right>_{\partial \Omega}
            - \left< \Phi, P \, \delta Q \, P \right>_{\partial \Omega}
        \right] \\
        - 4 W_2 \left[ 
            2\left<\Phi, \left( \delta Q : Q \right) Q \right>_{\partial \Omega}
            + \left<\Phi, \left( Q : Q \right) \delta Q \right>_{\partial \Omega}
            - \frac23 S_0^2 \left<\Phi, \delta Q \right>_{\partial \Omega}
        \right] 
    \end{multlined}
\end{equation}
To finalize the weak form, we write:
\begin{equation}
    \delta Q
    =
    \sum_\nu \delta Q_\nu \Phi_\nu
\end{equation}
and stipulate that the above must be true for every test function $\Phi_\mu$.
Then the weak form matrix equation reads:
\begin{equation}
    \left< \Phi_\mu, dT^S \Phi_\nu \right>_{\partial \Omega}
    =
    \begin{multlined}[t]
        -2 W_1 \left[ 
            \left< \Phi_\mu, \Phi_\nu \right>_{\partial \Omega}
            - \left< \Phi_\mu, P \Phi_\nu P \right>_{\partial \Omega}
        \right] \\
        - 4 W_2 \left[
            2 \left< \Phi_\mu, \left( \Phi_\nu : Q \right) Q \right>_{\partial \Omega}
            + \left< \Phi_\mu, \left( Q : Q \right) \Phi_\nu \right>_{\partial \Omega}
            - \tfrac23 S_0^2 \left< \Phi_\mu, \Phi_\nu \right>_{\partial \Omega}
        \right]
    \end{multlined}
\end{equation}

\section{Writing out explicitly}

The automatic code generation doesn't quite work, so we write out the bare minimum terms here as a check.
Our basis is given explicitly by:
\begin{equation}
    \Phi_1
    =
    \begin{bmatrix}
    \phi &0 &0 \\
    0 &0 &0 \\
    0 &0 &-\phi
    \end{bmatrix}
    \:\:\:
    \Phi_2
    =
    \begin{bmatrix}
    0 &\phi &0 \\
    \phi &0 &0 \\
    0 &0 &0
    \end{bmatrix}
    \:\:\:
    \Phi_3
    =
    \begin{bmatrix}
    0 &0 &\phi \\
    0 &0 &0 \\
    \phi &0 &0
    \end{bmatrix}
    \:\:\:
    \Phi_4
    =
    \begin{bmatrix}
    0 &0 &0 \\
    0 &\phi &0 \\
    0 &0 &-\phi
    \end{bmatrix}
    \:\:\:
    \Phi_5
    =
    \begin{bmatrix}
    0 &0 &0 \\
    0 &0 &\phi \\
    0 &\phi &0
    \end{bmatrix}
    \:\:\:
\end{equation}
So that $Q$ is given by:
\begin{equation}
    Q
    =
    \begin{bmatrix}
    Q_1 &Q_2 &Q_3 \\
    Q_2 &Q_4 &Q_5 \\
    Q_3 &Q_5 &-(Q_1 + Q_4)
    \end{bmatrix}
\end{equation}
Then we calculate:
\begin{equation}
\begin{split}
    \left<\Phi_1, Q\right>_{\partial \Omega}
    &=
    \int_{\partial \Omega} \left( 2Q_1 + Q_4 \right) \phi \\
    \left<\Phi_2, Q\right>_{\partial \Omega}
    &=
    \int_{\partial \Omega} 2 Q_2 \phi \\
    \left<\Phi_3, Q\right>_{\partial \Omega}
    &=
    \int_{\partial \Omega} 2 Q_3 \phi \\
    \left<\Phi_4, Q\right>_{\partial \Omega}
    &=
    \int_{\partial \Omega} \left( 2 Q_4 + Q_1 \right) \phi \\
    \left<\Phi_5, Q\right>_{\partial \Omega}
    &=
    \int_{\partial \Omega} 2 Q_5 \phi
\end{split}
\end{equation}
And the inner product of the basis functions:
\begin{equation}
\begin{split}
    \left<\Phi_i, \Phi_i\right>_{\partial \Omega}
    &=
    \int_{\partial \Omega} 2 \phi_i \phi_i \\
    \left<\Phi_1, \Phi_4\right>_{\partial \Omega}
    &=
    \int_{\partial \Omega} \phi_1 \phi_4 \\
    \left<\Phi_4, \Phi_1\right>_{\partial \Omega}
    &=
    \int_{\partial \Omega} \phi_1 \phi_4
\end{split}
\end{equation}
All other inner products are zero.

\end{document}
